---
description: Mandatory rules and guidelines for development, building, and testing
---

# Project Development Rules

All AI agents and developers must strictly adhere to these rules when working on this project.

## 1. Directory Structure Constraints
- **READ-ONLY Directories**: `Core/`, `Drivers/`, `Middlewares/`, `cmake/`.
  - These contain code generated by STM32CubeMX or third-party libraries.
  - Do NOT modify files here unless explicitly instructed (e.g., hooking `main.c`).
- **Working Directory**: `user/`.
  - All new features, application logic, and user drivers MUST be implemented here.

## 2. Build System
The project uses a dual build system.
- **CLI Build** (Standard): Use the provided wrapper script.
  - **Command**: `./build_cli.sh`
  - **Artifacts**: `build_cli/`
  - **Clean**: `./build_cli.sh clean` or `./build_cli.sh d cb` (clean-build)
- **IDE Build** (Debugging): Output goes to `build/`. Do NOT use for CLI tasks.

## 3. Unit Testing & Verification
Test-Driven Development (TDD) is enforced using Ceedling.
- **Execution**: ALWAYS use the `test.sh` wrapper script.
  - Run All Tests: `./test.sh`
  - Run Specific Test: `./test.sh ceedling test:test_[name]`
  - Coverage: `./test.sh gcov`
  - Complexity: `./test.sh lizard`
- **Verification Rule**: Before finishing any task involving code changes in `user/`, you MUST run `./test.sh` and ensure all tests pass.

## 4. Coding Conventions
- **RTOS API**:
  - Prefer **FreeRTOS Native API** (`vTaskDelay`, `xTaskCreate`, etc.) over CMSIS-OS wrappers (`osDelay`).
  - This simplifies mocking for unit tests.
- **Mocking Strategy**:
  - Use `mock_task.h` (FreeRTOS) for logic verification.
  - Use `ceedling/test/support/stubs.c` only for HAL/System functions required for linking (e.g., `HAL_GPIO_TogglePin`).

## 5. Environment
- **Docker**: Unit tests run inside a Docker container (handled by `test.sh`).
- **Python**: `lizard` runs on the host machine.
- **Compiler**:
  - Host Tests: `gcc` (via Docker).
  - Target Build: `arm-none-eabi-gcc` (via `build_cli.sh`).

## 6. Version Control
- **Commits**: The USER performs all git commits. The Agent should NOT commit changes but may suggest commit messages or prepare files for staging.

# Mecanum Wheel Project

## 1. Project Structure & Architecture
The project follows a strict separation between auto-generated code and user application code.

- **`Core/`, `Drivers/`, `Middlewares/`**: Contains code generated by STM32CubeMX.
  - ⚠️ **Do not modify logic here** unless absolutely necessary (e.g., `main.c` hooks).
  - Treat these as platform drivers/HAL.
- **`user/`**: Contains all custom application logic.
  - **All new features must be implemented here.**
  - `user/app`: Application layer.
  - `user/drv`: User-level drivers.
  - `user/lib`: Shared libraries.

## 2. Build System
The project supports two parallel build systems. Do not mix them.

### A. IDE Build (GUI)
- **Tool**: VSCode / STM32CubeIDE
- **Output Directory**: `build/`
- **Use Case**: Debugging, Breakpoints, Hardware Trace.

### B. CLI Build (Terminal)
- **Tool**: CMake + `build_cli.sh`
- **Output Directory**: `build_cli/`
- **Use Case**: CI/CD, Quick compiling, Clean builds.
- **Usage**:
  ```bash
  ./build_cli.sh       # Incremental Debug build
  ./build_cli.sh d cb  # Clean Debug build
  ```
  *(See `BUILD_CLI_GUIDE.md` for details)*

## 3. Unit Testing & Quality Assurance
We follow Test-Driven Development (TDD) using Ceedling (Unity + CMock).

- **Scope**: Only code in `user/` is unit tested.
- **Execution**: Use the `test.sh` wrapper script (Dockerized).
- **Environment**: Host-based testing (GCC). Embedded dependencies (HAL, RTOS) are mocked or stubbed.

### Key Commands
```bash
./test.sh             # Run all tests
./test.sh ceedling [task] # Run specific task (e.g. test:test_app)
./test.sh gcov        # Generate code coverage report
./test.sh lizard      # Run complexity analysis
```
*(See `TEST_GUIDE.md` for details)*

## 4. Coding Standards & Conventions

### RTOS API
- **Prefer Native FreeRTOS API**: Use `vTaskDelay`, `xTaskCreate` instead of CMSIS-OS wrappers (`osDelay`) in `user/` code.
- **Reason**: Simplifies testing by allowing straightforward mocking of `mock_task.h` without CMSIS wrapper complexity.

### Mocking & Stubbing
- **Stub**: Use `ceedling/test/support/stubs.c` for simple Functions strictly required for linking (e.g., `HAL_GPIO_TogglePin`).
- **Mock**: Use Ceedling's automatic mocking for logic verification (e.g., `mock_task.h`).

## 5. Git & Version Control
- **Ignored Directories**:
  - `build/`
  - `build_cli/`
  - `ceedling/build/`
- **Commit Strategy**: Keep commits atomic. Ensure tests pass (`./test.sh`) before pushing.
